<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Apple Store â€” E-commerce</title>
  <style>
    /* â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      min-height: 100vh;
    }

    /* â”€â”€ Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    nav {
      background: rgba(22,22,23,.9);
      backdrop-filter: saturate(180%) blur(20px);
      position: sticky; top: 0; z-index: 100;
      padding: 0 24px;
      display: flex; align-items: center; justify-content: space-between;
      height: 52px;
    }
    .nav-brand { color: #f5f5f7; font-size: 22px; }
    .nav-actions { display: flex; gap: 16px; align-items: center; }
    .btn-nav {
      background: none; border: 1px solid #555; border-radius: 20px;
      color: #f5f5f7; padding: 6px 16px; cursor: pointer; font-size: 13px;
      transition: all .2s;
    }
    .btn-nav:hover { background: #555; }
    .cart-badge {
      background: #0071e3; color: #fff;
      border-radius: 50%; width: 20px; height: 20px;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 11px; font-weight: 700; margin-left: 4px;
    }

    /* â”€â”€ Hero â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .hero {
      background: linear-gradient(135deg, #1d1d1f 0%, #2d2d2f 100%);
      color: #f5f5f7; text-align: center; padding: 80px 24px 60px;
    }
    .hero h1 { font-size: clamp(32px, 5vw, 56px); font-weight: 700; letter-spacing: -.5px; }
    .hero p  { font-size: 18px; color: #a1a1a6; margin-top: 12px; }

    /* â”€â”€ Secciones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    section { padding: 48px 24px; max-width: 1200px; margin: 0 auto; }
    .section-title {
      font-size: 28px; font-weight: 700; margin-bottom: 24px;
      display: flex; align-items: center; gap: 10px;
    }

    /* â”€â”€ Grid de productos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #grid-productos {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 20px;
    }
    .card {
      background: #fff; border-radius: 18px;
      padding: 24px 20px; text-align: center;
      box-shadow: 0 2px 16px rgba(0,0,0,.06);
      transition: transform .2s, box-shadow .2s;
      display: flex; flex-direction: column; gap: 10px;
    }
    .card:hover { transform: translateY(-4px); box-shadow: 0 8px 30px rgba(0,0,0,.12); }
    .card-emoji { font-size: 48px; }
    .card-nombre { font-size: 15px; font-weight: 600; }
    .card-precio { font-size: 20px; font-weight: 700; color: #0071e3; }
    .card-stock  { font-size: 12px; color: #6e6e73; }
    .card-stock.bajo { color: #ff3b30; font-weight: 600; }
    .btn-agregar {
      margin-top: 4px;
      background: #0071e3; color: #fff; border: none;
      border-radius: 980px; padding: 10px 20px; cursor: pointer;
      font-size: 14px; font-weight: 500; transition: background .2s;
    }
    .btn-agregar:hover:not(:disabled) { background: #0077ed; }
    .btn-agregar:disabled { background: #c7c7cc; cursor: default; }

    /* â”€â”€ Carrito â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #carrito-panel {
      position: fixed; right: 0; top: 52px; bottom: 0; width: 360px;
      background: #fff; box-shadow: -4px 0 30px rgba(0,0,0,.12);
      transform: translateX(100%); transition: transform .3s ease;
      z-index: 99; display: flex; flex-direction: column;
    }
    #carrito-panel.abierto { transform: translateX(0); }
    .cart-header {
      padding: 20px 24px; border-bottom: 1px solid #e5e5e5;
      display: flex; justify-content: space-between; align-items: center;
    }
    .cart-header h2 { font-size: 18px; font-weight: 700; }
    .btn-cerrar-cart {
      background: none; border: none; font-size: 22px;
      cursor: pointer; color: #6e6e73; line-height: 1;
    }
    #lista-carrito { flex: 1; overflow-y: auto; padding: 16px 24px; }
    .cart-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 0; border-bottom: 1px solid #f2f2f2;
      gap: 10px;
    }
    .cart-item-info { flex: 1; }
    .cart-item-nombre { font-size: 13px; font-weight: 600; }
    .cart-item-precio { font-size: 12px; color: #6e6e73; }
    .cart-item-qty {
      display: flex; align-items: center; gap: 8px;
    }
    .btn-qty {
      background: #f2f2f2; border: none; border-radius: 50%;
      width: 26px; height: 26px; cursor: pointer; font-size: 16px;
      display: flex; align-items: center; justify-content: center;
    }
    .btn-remove { background: none; border: none; color: #ff3b30; cursor: pointer; font-size: 16px; }
    .cart-footer {
      padding: 20px 24px; border-top: 1px solid #e5e5e5;
    }
    .cart-total {
      display: flex; justify-content: space-between;
      font-size: 16px; font-weight: 700; margin-bottom: 16px;
    }
    .btn-comprar {
      width: 100%; background: #0071e3; color: #fff;
      border: none; border-radius: 980px; padding: 14px;
      font-size: 16px; font-weight: 600; cursor: pointer;
      transition: background .2s;
    }
    .btn-comprar:hover:not(:disabled) { background: #0077ed; }
    .btn-comprar:disabled { background: #c7c7cc; cursor: default; }

    /* â”€â”€ Modal de confirmaciÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,.5);
      display: flex; align-items: center; justify-content: center;
      z-index: 200; opacity: 0; pointer-events: none;
      transition: opacity .3s;
    }
    .modal-backdrop.visible { opacity: 1; pointer-events: all; }
    .modal {
      background: #fff; border-radius: 24px; padding: 40px 36px;
      max-width: 420px; width: 90%; text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,.2);
      transform: scale(.95); transition: transform .3s;
    }
    .modal-backdrop.visible .modal { transform: scale(1); }
    .modal-icon { font-size: 64px; margin-bottom: 16px; }
    .modal h2  { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
    .modal p   { color: #6e6e73; margin-bottom: 20px; }
    .modal-detalle {
      background: #f5f5f7; border-radius: 12px; padding: 16px;
      text-align: left; margin-bottom: 24px; font-size: 13px;
    }
    .modal-detalle p { color: #1d1d1f; margin-bottom: 4px; }
    .modal-detalle .total-modal { font-weight: 700; font-size: 16px; color: #0071e3; }
    .btn-modal {
      background: #0071e3; color: #fff; border: none;
      border-radius: 980px; padding: 12px 32px;
      font-size: 15px; font-weight: 600; cursor: pointer;
    }

    /* â”€â”€ Tabla de ventas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #tabla-ventas-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th {
      background: #1d1d1f; color: #f5f5f7;
      padding: 12px 14px; text-align: left; font-weight: 500;
    }
    td { padding: 10px 14px; border-bottom: 1px solid #e5e5e5; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #fafafa; }
    .badge-uuid {
      font-family: monospace; font-size: 11px;
      background: #f5f5f7; padding: 2px 6px; border-radius: 4px;
    }

    /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast {
      position: fixed; bottom: 32px; left: 50%; transform: translateX(-50%) translateY(20px);
      background: #1d1d1f; color: #fff; padding: 12px 24px;
      border-radius: 980px; font-size: 14px; font-weight: 500;
      opacity: 0; transition: all .3s; z-index: 300; pointer-events: none;
    }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* â”€â”€ Empty states â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .empty { color: #a1a1a6; text-align: center; padding: 32px; font-size: 14px; }

    /* â”€â”€ Spinner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .spinner {
      display: inline-block; width: 18px; height: 18px;
      border: 2px solid rgba(255,255,255,.3);
      border-top-color: #fff; border-radius: 50%;
      animation: spin .7s linear infinite; vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Admin bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .admin-bar {
      background: #fff; border-radius: 18px;
      padding: 24px; margin-bottom: 24px;
      box-shadow: 0 2px 16px rgba(0,0,0,.06);
    }
    .admin-bar h3 { font-size: 15px; font-weight: 600; margin-bottom: 16px; color: #6e6e73; }
    .admin-form {
      display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end;
    }
    .admin-form input {
      border: 1px solid #d2d2d7; border-radius: 10px;
      padding: 10px 14px; font-size: 14px; outline: none;
      transition: border-color .2s;
    }
    .admin-form input:focus { border-color: #0071e3; }
    .admin-form input[type=text] { flex: 2; min-width: 160px; }
    .admin-form input[type=number] { width: 110px; }
    .btn-admin {
      border: none; border-radius: 10px; padding: 10px 18px;
      cursor: pointer; font-size: 14px; font-weight: 500;
    }
    .btn-add  { background: #34c759; color: #fff; }
    .btn-add:hover { background: #30b550; }
    .btn-del  { background: #ff3b30; color: #fff; }
    .btn-del:hover { background: #e0352b; }

    @media (max-width: 600px) {
      #carrito-panel { width: 100%; }
    }
  </style>
</head>
<body>

<!-- â”€â”€ NavegaciÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<nav>
  <span class="nav-brand">ğŸ</span>
  <div class="nav-actions">
    <button class="btn-nav" id="btn-ver-ventas">ğŸ“‹ Ventas</button>
    <button class="btn-nav" id="btn-abrir-carrito">
      ğŸ›’ Carrito <span class="cart-badge" id="badge-cart">0</span>
    </button>
  </div>
</nav>

<!-- â”€â”€ Hero â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="hero">
  <h1>Apple Store</h1>
  <p>Los mejores productos, en un solo lugar.</p>
</div>

<!-- â”€â”€ SecciÃ³n Productos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<section id="sec-productos">
  <div class="section-title">ğŸ“¦ Productos</div>

  <!-- Panel de administraciÃ³n -->
  <div class="admin-bar">
    <h3>âš™ï¸ Panel de AdministraciÃ³n</h3>
    <div class="admin-form">
      <input type="text"   id="adm-nombre" placeholder="Nombre del producto" />
      <input type="number" id="adm-precio" placeholder="Precio" min="0" step="0.01" />
      <input type="number" id="adm-stock"  placeholder="Stock" min="0" step="1" />
      <button class="btn-admin btn-add" id="btn-add-prod">+ Agregar</button>
    </div>
  </div>

  <div id="grid-productos">
    <div class="empty">Cargando productosâ€¦</div>
  </div>
</section>

<!-- â”€â”€ SecciÃ³n Ventas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<section id="sec-ventas" style="display:none">
  <div class="section-title">ğŸ“‹ Historial de Ventas
    <button class="btn-nav" style="font-size:13px" id="btn-volver-prod">â† Volver</button>
  </div>
  <div id="tabla-ventas-wrap">
    <div class="empty">Cargando ventasâ€¦</div>
  </div>
</section>

<!-- â”€â”€ Panel Carrito â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="carrito-panel">
  <div class="cart-header">
    <h2>ğŸ›’ Mi Carrito</h2>
    <button class="btn-cerrar-cart" id="btn-cerrar-carrito">Ã—</button>
  </div>
  <div id="lista-carrito">
    <div class="empty">El carrito estÃ¡ vacÃ­o</div>
  </div>
  <div class="cart-footer">
    <div class="cart-total">
      <span>Total</span>
      <span id="cart-total-precio">$0.00</span>
    </div>
    <button class="btn-comprar" id="btn-comprar" disabled>Comprar ahora</button>
  </div>
</div>

<!-- â”€â”€ Modal ConfirmaciÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-backdrop" id="modal-backdrop">
  <div class="modal">
    <div class="modal-icon" id="modal-icon">âœ…</div>
    <h2 id="modal-titulo">Â¡Compra exitosa!</h2>
    <p id="modal-subtitulo">Tu pedido ha sido registrado.</p>
    <div class="modal-detalle" id="modal-detalle"></div>
    <button class="btn-modal" id="btn-modal-cerrar">Continuar comprando</button>
  </div>
</div>

<!-- â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="toast"></div>

<!-- â”€â”€ Script principal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script>
// ============================================================
//  Estado global
// ============================================================
let carrito = [];      // [{ producto, cantidad }]
let productos = [];    // cachÃ© de productos del servidor

// ============================================================
//  Helpers de UI
// ============================================================
const toast = (msg, dur = 2500) => {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), dur);
};

const emoji = (nombre) => {
  if (/macbook/i.test(nombre))  return 'ğŸ’»';
  if (/ipad/i.test(nombre))     return 'ğŸ“±';
  if (/iphone/i.test(nombre))   return 'ğŸ“±';
  if (/watch/i.test(nombre))    return 'âŒš';
  if (/airpods max/i.test(nombre)) return 'ğŸ§';
  if (/airpods/i.test(nombre))  return 'ğŸµ';
  if (/imac/i.test(nombre))     return 'ğŸ–¥ï¸';
  if (/mac pro/i.test(nombre))  return 'ğŸ–¥ï¸';
  if (/mac mini/i.test(nombre)) return 'ğŸ–¨ï¸';
  return 'ğŸ“¦';
};

const fmt = (n) => `$${Number(n).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`;

// ============================================================
//  API calls
// ============================================================
const API = {
  async getProductos()         { const r = await fetch('/productos');          return r.json(); },
  async getVentas()            { const r = await fetch('/ventas');             return r.json(); },
  async postProducto(body)     { const r = await fetch('/producto', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) }); return r; },
  async deleteProducto(id)     { const r = await fetch('/producto', { method:'DELETE', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id_producto: id }) }); return r; },
  async postVenta(items)       {
    const r = await fetch('/venta', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ items, id_usuario: null })
    });
    return r;
  }
};

// ============================================================
//  Renderizado de productos
// ============================================================
async function cargarProductos() {
  const grid = document.getElementById('grid-productos');
  grid.innerHTML = '<div class="empty">Cargandoâ€¦</div>';
  try {
    productos = await API.getProductos();
    renderProductos();
  } catch (e) {
    grid.innerHTML = '<div class="empty">âš ï¸ Error al cargar productos. Â¿EstÃ¡ el servidor corriendo?</div>';
  }
}

function renderProductos() {
  const grid = document.getElementById('grid-productos');
  if (!productos.length) {
    grid.innerHTML = '<div class="empty">No hay productos disponibles.</div>';
    return;
  }
  grid.innerHTML = productos.map(p => {
    const stockClass = p.stock <= 3 ? 'bajo' : '';
    const stockText  = p.stock === 0 ? 'âŒ Sin stock' : p.stock <= 3 ? `âš ï¸ Ãšltimas ${p.stock} unidades` : `âœ… Stock: ${p.stock}`;
    const enCarrito  = carrito.find(i => i.producto.id_producto === p.id_producto);
    const btnLabel   = enCarrito ? `En carrito (${enCarrito.cantidad})` : 'Agregar al carrito';

    return `
      <div class="card" id="card-${p.id_producto}">
        <div class="card-emoji">${emoji(p.nombre)}</div>
        <div class="card-nombre">${p.nombre}</div>
        <div class="card-precio">${fmt(p.precio)}</div>
        <div class="card-stock ${stockClass}">${stockText}</div>
        <button class="btn-agregar" ${p.stock === 0 ? 'disabled' : ''} onclick="agregarAlCarrito(${p.id_producto})">
          ${btnLabel}
        </button>
        <button class="btn-admin btn-del" style="font-size:12px;padding:6px 12px" onclick="eliminarProducto(${p.id_producto})">
          ğŸ—‘ Eliminar
        </button>
      </div>
    `;
  }).join('');
}

// ============================================================
//  Carrito
// ============================================================
function agregarAlCarrito(id) {
  const producto = productos.find(p => p.id_producto === id);
  if (!producto || producto.stock === 0) return;

  const item = carrito.find(i => i.producto.id_producto === id);
  if (item) {
    if (item.cantidad >= producto.stock) {
      toast(`MÃ¡ximo disponible: ${producto.stock} unidades`);
      return;
    }
    item.cantidad++;
  } else {
    carrito.push({ producto, cantidad: 1 });
  }
  actualizarCarritoUI();
  toast(`${producto.nombre} agregado ğŸ›’`);
}

function cambiarCantidad(id, delta) {
  const idx = carrito.findIndex(i => i.producto.id_producto === id);
  if (idx === -1) return;
  carrito[idx].cantidad += delta;
  if (carrito[idx].cantidad <= 0) {
    carrito.splice(idx, 1);
  }
  actualizarCarritoUI();
}

function actualizarCarritoUI() {
  const lista   = document.getElementById('lista-carrito');
  const badge   = document.getElementById('badge-cart');
  const total   = document.getElementById('cart-total-precio');
  const btnComp = document.getElementById('btn-comprar');

  const totalItems = carrito.reduce((a, i) => a + i.cantidad, 0);
  const totalPrecio = carrito.reduce((a, i) => a + i.producto.precio * i.cantidad, 0);

  badge.textContent = totalItems;
  total.textContent = fmt(totalPrecio);
  btnComp.disabled  = carrito.length === 0;

  if (!carrito.length) {
    lista.innerHTML = '<div class="empty">El carrito estÃ¡ vacÃ­o</div>';
  } else {
    lista.innerHTML = carrito.map(({ producto, cantidad }) => `
      <div class="cart-item">
        <div class="cart-item-info">
          <div class="cart-item-nombre">${producto.nombre}</div>
          <div class="cart-item-precio">${fmt(producto.precio)} Ã— ${cantidad} = ${fmt(producto.precio * cantidad)}</div>
        </div>
        <div class="cart-item-qty">
          <button class="btn-qty" onclick="cambiarCantidad(${producto.id_producto}, -1)">âˆ’</button>
          <span>${cantidad}</span>
          <button class="btn-qty" onclick="cambiarCantidad(${producto.id_producto}, +1)">+</button>
        </div>
        <button class="btn-remove" onclick="cambiarCantidad(${producto.id_producto}, -999)" title="Quitar">âœ•</button>
      </div>
    `).join('');
  }

  // Actualizar botones de "Agregar" en las tarjetas
  renderProductos();
}

// â”€â”€ Panel carrito â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('btn-abrir-carrito').addEventListener('click', () => {
  document.getElementById('carrito-panel').classList.add('abierto');
});
document.getElementById('btn-cerrar-carrito').addEventListener('click', () => {
  document.getElementById('carrito-panel').classList.remove('abierto');
});

// ============================================================
//  Compra
// ============================================================
document.getElementById('btn-comprar').addEventListener('click', async () => {
  const btn = document.getElementById('btn-comprar');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Procesandoâ€¦';

  const items = carrito.map(i => ({
    id_producto: i.producto.id_producto,
    cantidad:    i.cantidad
  }));

  try {
    const response = await API.postVenta(items);
    const data = await response.json();

    if (response.ok) {
      // â”€â”€ Ã‰xito â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      mostrarModal({
        icono: 'âœ…',
        titulo: 'Â¡Compra exitosa!',
        subtitulo: 'Tu pedido fue registrado correctamente.',
        detalle: data.venta
      });
      // Actualizar stock local en cachÃ©
      data.venta.items.forEach(vi => {
        const p = productos.find(p => p.id_producto === vi.id_producto);
        if (p) p.stock -= vi.cantidad;
      });
      carrito = [];
      actualizarCarritoUI();
      document.getElementById('carrito-panel').classList.remove('abierto');
    } else {
      // â”€â”€ Error del servidor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      mostrarModal({
        icono: 'âš ï¸',
        titulo: 'No se pudo completar la compra',
        subtitulo: data.error || 'OcurriÃ³ un error.',
        detalle: null
      });
    }
  } catch (err) {
    mostrarModal({
      icono: 'âŒ',
      titulo: 'Error de conexiÃ³n',
      subtitulo: 'No se pudo contactar al servidor.',
      detalle: null
    });
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Comprar ahora';
  }
});

function mostrarModal({ icono, titulo, subtitulo, detalle }) {
  document.getElementById('modal-icon').textContent     = icono;
  document.getElementById('modal-titulo').textContent   = titulo;
  document.getElementById('modal-subtitulo').textContent = subtitulo;

  const detalleEl = document.getElementById('modal-detalle');
  if (detalle) {
    const itemsHTML = detalle.items.map(i =>
      `<p>â€¢ ${i.nombre} Ã— ${i.cantidad} â†’ ${fmt(i.subtotal)}</p>`
    ).join('');
    detalleEl.innerHTML = `
      ${itemsHTML}
      <hr style="border:none;border-top:1px solid #d2d2d7;margin:10px 0">
      <p class="total-modal">Total pagado: ${fmt(detalle.total)}</p>
      <p style="font-size:11px;color:#a1a1a6;margin-top:4px">ID: <span class="badge-uuid">${detalle.id_venta}</span></p>
    `;
    detalleEl.style.display = 'block';
  } else {
    detalleEl.style.display = 'none';
  }

  document.getElementById('modal-backdrop').classList.add('visible');
}

document.getElementById('btn-modal-cerrar').addEventListener('click', () => {
  document.getElementById('modal-backdrop').classList.remove('visible');
});
document.getElementById('modal-backdrop').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) e.currentTarget.classList.remove('visible');
});

// ============================================================
//  Admin â€” Agregar producto
// ============================================================
document.getElementById('btn-add-prod').addEventListener('click', async () => {
  const nombre = document.getElementById('adm-nombre').value.trim();
  const precio = parseFloat(document.getElementById('adm-precio').value);
  const stock  = parseInt(document.getElementById('adm-stock').value, 10);

  if (!nombre || isNaN(precio) || isNaN(stock)) {
    toast('âš ï¸ Completa todos los campos del formulario');
    return;
  }

  const res  = await API.postProducto({ nombre, precio, stock });
  const data = await res.json();

  if (res.ok) {
    toast(`âœ… Producto "${nombre}" creado`);
    document.getElementById('adm-nombre').value = '';
    document.getElementById('adm-precio').value = '';
    document.getElementById('adm-stock').value  = '';
    await cargarProductos();
  } else {
    toast(`âš ï¸ ${data.error}`);
  }
});

// ============================================================
//  Admin â€” Eliminar producto
// ============================================================
async function eliminarProducto(id) {
  if (!confirm('Â¿Eliminar este producto? Se marcarÃ¡ como inactivo.')) return;
  const res  = await API.deleteProducto(id);
  const data = await res.json();
  if (res.ok) {
    toast('ğŸ—‘ Producto eliminado');
    await cargarProductos();
  } else {
    toast(`âš ï¸ ${data.error}`);
  }
}

// ============================================================
//  Ventas
// ============================================================
document.getElementById('btn-ver-ventas').addEventListener('click', async () => {
  document.getElementById('sec-productos').style.display = 'none';
  document.getElementById('sec-ventas').style.display    = 'block';
  document.getElementById('carrito-panel').classList.remove('abierto');

  const wrap = document.getElementById('tabla-ventas-wrap');
  wrap.innerHTML = '<div class="empty">Cargando ventasâ€¦</div>';

  try {
    const ventas = await API.getVentas();
    if (!ventas.length) {
      wrap.innerHTML = '<div class="empty">No hay ventas registradas aÃºn.</div>';
      return;
    }
    wrap.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>ID Venta</th>
            <th>Fecha</th>
            <th>Productos</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          ${ventas.map(v => `
            <tr>
              <td><span class="badge-uuid">${v.id_venta.slice(0, 8)}â€¦</span></td>
              <td>${new Date(v.fecha).toLocaleString('es-CL')}</td>
              <td>${v.items.map(i => `${i.nombre} Ã—${i.cantidad}`).join('<br>')}</td>
              <td><strong>${fmt(v.total)}</strong></td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  } catch (e) {
    wrap.innerHTML = '<div class="empty">âš ï¸ Error al cargar ventas.</div>';
  }
});

document.getElementById('btn-volver-prod').addEventListener('click', () => {
  document.getElementById('sec-ventas').style.display    = 'none';
  document.getElementById('sec-productos').style.display = 'block';
});

// ============================================================
//  Init
// ============================================================
cargarProductos();
</script>
</body>
</html>
